local dump = require 'luadump'
local inspect = require('inspect')
local vec3 = require 'vec3'
local transf = require 'transf'
local fileUtils = require('fileUtils')
local stringUtils = require('stringUtils')

function data()
    --local test = require('lollo_medium_1_way_1_lane_street.lua')
    local function readFiles(files)

        print('LOLLO current path = ')
        dump(true)(fileUtils.getCurrentPath())
        print('LOLLO package paths = ')
        dump(true)(fileUtils.getPackagePaths())
        print('LOLLO package cpaths = ')
        dump(true)(fileUtils.getPackageCpaths())
        print('LOLLO package.loaded = ')
        --dump(true)(package.loaded) huge
        for key, value in pairs(package.loaded) do
            print(key, value)
        end

        -- this works
        local fileDatas = {}
        local currPath = fileUtils.getCurrentPath()
        print('LOLLO currPath is')
        dump(true)(currPath)
        if not stringUtils.isNullOrEmptyString(currPath) then
            local resDir = fileUtils.getResDirFromPath(currPath)
            print('LOLLO resDir is')
            dump(true)(resDir)
            if not stringUtils.isNullOrEmptyString(resDir) then
                local streetDir = resDir .. '/config/street'
                print('LOLLO streetDir is')
                dump(true)(streetDir)

                if not stringUtils.isNullOrEmptyString(streetDir) then
                    local streetFiles = fileUtils.getFilesInDirWithExtension(streetDir, 'lua')
                    --streetFiles = "C:/Program Files (x86)/Steam/userdata/71590188/1066780/local/staging_area/lollo_street_tuning_1/res/config/street"
                    print('LOLLO streetfiles are')
                    dump(true)(streetFiles)
                    if type(streetFiles) == 'table' then
                        for i = 1, #streetFiles do
                            local isOk, fileData = fileUtils.readGameDataFile(streetFiles[i])
                            if isOk then
                                table.insert(
                                    fileDatas,
                                    #fileDatas + 1,
                                    {
                                        type = fileData.type,
                                        streetWidth = fileData.streetWidth,
                                        sidewalkWidth = fileData.sidewalkWidth
                                    }
                                )
                            end
                        end
                        for i = 1, #fileDatas do
                            dump(true)(fileDatas[i])
                        end
                    end
                end
            end
        end

        -- LOLLO NOTE very useful to see what is going on
        -- print('LOLLO debug.getregistry() = ')
        -- print(inspect(debug.getregistry()))

        -- LOLLO NOTE you can save the global var in game or in _G
        -- print('LOLLO game.config = ')
        -- -- dump(true)(game)
        -- for key, value in pairs(game.config) do
        --     print(key, value)
        -- end
        -- print('LOLLO game.res = ')
        -- for key, value in pairs(game.res) do
        --     print(key, value)
        -- end
        -- this fails coz game.interface is not on this thread
        -- local func = function()
        --     return game.interface.findPath('lollo_medium_4_lane_street')
        -- end
        -- local ok, fc = pcall(func)
        -- if ok then
        --     print('LOLLO test 4 findPath succeeded')
        --     dump(true)(fc)
        --     dump(true)(fc())
        -- else
        --     print('Execution error:', fc)
        -- end

        -- You can change package.path (not with ?.lua but with the whole file name) and then require a street file,
        -- but the required file does not return anything,
        -- because this is how street files are designed. So I need to read the file and parse it somehow.
        -- local modPath
        -- if string.ends(info.source, 'mod.lua') then
        --     modPath = string.gsub(info.source, "@(.*/)mod[.]lua", "%1")
        -- elseif string.ends(info.source, '.mdl') then
        --     modPath = string.gsub(info.source, "@(.*/)res/models/model/.+[.]mdl", "%1")
        -- elseif string.ends(info.source, '.lua') then
        --     modPath = string.gsub(info.source, "@(.*/)res/config/street/.+[.]lua", "%1")
        -- end
    end

    readFiles({})

    return {
        type = 'STREET_CONSTRUCTION',
        description = {
            name = _('Parallel streets'),
            description = _('Lays two parallel streets.')
        },
        availability = {
            yearFrom = 0,
            yearTo = 0
        },
        -- params = { -- LOLLO here, you can add some parameters, such as the street type
        --     {
        --         key = "streetType2",
        --         name = _("Number of lanes"),
        --         values = { _("2"), _("3") },
        --         defaultIndex = 0,
        --         yearFrom = 1960,
        --         yearTo = 0
        --     },
        --     {
        --         key = "scale",
        --         name = _("Scale"),
        --         values = { _("Small"), _("Medium"), _("Large") },
        --         defaultIndex = 0,
        --         yearFrom = 1960,
        --         yearTo = 0
        --     },
        -- },

        order = 1,
        -- collider = {
        --     type = 'NONE'
        -- },
        -- autoRemovable = true,
        --skipCollision = true,
        --skipCollisionCheck = true,
        updateFn = function(params)
            print('LOLLO parallel streets updateFn')
            -- dump(true)(params)

            local result = {}
            --result.colliders = {}
            result.cost = 0
            --result.edgeLists = {}
            result.models = {}
            result.groundFaces = {}
            --		result.h0 = {}
            --		result.h1 = {}
            -- result.collider = {
            --     type = 'NONE'
            -- }
            -- result.autoRemovable = true
            -- result.skipCollision = true
            -- result.skipCollisionCheck = true
            --		result.stations = {}
            --		result.terminalGroups = {}
            --		result.terrainAlignmentLists = {}
            -- result.terrainAlignmentLists = {
            --     {
            --         type = 'EQUAL',
            --         faces = {}
            --     }
            -- }
            -- result.models = {
            --     {
            --         --id = "asset/icon/marker_exclamation.mdl",
            --         --id = "asset/icon/mark.mdl",
            --         --id = "station/street/mark.mdl",
            --         id = 'lollo_assets/mark.mdl',
            --         collider = {
            --             type = 'NONE'
            --         },
            --         autoRemovable = true,
            --         skipCollision = true,
            --         skipCollisionCheck = true,
            --         transf = transf.transl(vec3.new(0.0, 0.0, .0))
            --     }
            -- }

            result.edgeLists = {
                {
                    type = 'STREET',
                    params = {
                        -- collider = {
                        --     type = 'NONE'
                        -- },
                        -- autoRemovable = true,
                        -- skipCollision = true,
                        -- skipCollisionCheck = true,
                        type = 'lollo_medium_1_way_1_lane_street.lua' -- from res/config/street/
                        -- tramTrackType = 'NO'
                    },
                    edges = {
                        -- one entry refers to a position and a tangent
                        {{-4, -4, .0}, {1, .0, .0}}, -- node 0
                        {{4, -4, .0}, {1, .0, .0}} -- node 1
                    },
                    -- edgeType = "BRIDGE",
                    -- edgeTypeName = "cement.lua",
                    freeNodes = {0, 1},
                    --freeNodes = { 1 },
                    -- freeNodes = {},
                    -- collider = {
                    --     type = 'NONE'
                    -- },
                    -- autoRemovable = true,
                    --skipCollision = true, --useless
                    --skipCollisionCheck = true, --useless
                    --					snapNodes = { 0 },  -- node 0 is allowed to snap to other edges of the same type --crashes
                    snapNodes = {0, 1}, -- node 1 is allowed to snap to other edges of the same type
                    snapNodes = {0},
                    snapNodes = {}
                    --					snapNodes = { 0, 1 },  -- node 0 and 1 are allowed to snap to other edges of the same type --crashes
                    --					tag2nodes = {},
                },
                {
                    type = 'STREET',
                    params = {
                        -- collider = {
                        --     type = 'NONE'
                        -- },
                        -- autoRemovable = true,
                        -- skipCollision = true,
                        -- skipCollisionCheck = true,
                        type = 'lollo_medium_1_way_1_lane_street.lua' -- from res/config/street/
                        -- tramTrackType = 'NO'
                    },
                    edges = {
                        -- one entry refers to a position and a tangent
                        {{-4, 4, .0}, {1, .0, .0}}, -- node 0
                        {{4, 4, .0}, {1, .0, .0}} -- node 1
                    },
                    -- edgeType = "BRIDGE",
                    -- edgeTypeName = "cement.lua",
                    freeNodes = {0, 1},
                    --freeNodes = { 1 },
                    --freeNodes = { },
                    -- collider = {
                    --     type = 'NONE'
                    -- },
                    -- autoRemovable = true,
                    --skipCollision = true, --useless
                    --skipCollisionCheck = true, --useless
                    snapNodes = {0, 1}, -- node 1 is allowed to snap to other edges of the same type
                    snapNodes = {0},
                    snapNodes = {}
                    --					tag2nodes = {},
                }
            }

            return result
        end,
        upgradeFn = function(params)
            -- print('LOLLO parallel streets upgradeFn')
            -- dump(true)(params)
        end
    }
end
